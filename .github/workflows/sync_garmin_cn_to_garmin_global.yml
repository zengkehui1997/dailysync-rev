name: Sync Garmin CN to Garmin Global

on:
  workflow_dispatch:
  schedule:
    # ä¸»é”šç‚¹ï¼ˆUTCï¼‰ï¼š23:18ã€00:18ã€01:18ã€02:18ã€09:18ã€13:18
    # â†” åŒ—äº¬æ—¶é—´ï¼š07:18ã€08:18ã€09:18ã€10:18ã€17:18ã€21:18
    - cron: "18 23,0,1,2,9,13 * * *"
    # å†—ä½™é”šç‚¹ï¼ˆUTCï¼‰ï¼š23:43ã€00:43ã€01:43ã€02:43ã€09:43ã€13:43
    # â†” åŒ—äº¬æ—¶é—´ï¼š07:43ã€08:43ã€09:43ã€10:43ã€17:43ã€21:43
    - cron: "43 23,0,1,2,9,13 * * *"
  push:
    branches:
      - main

# é¿å…é‡å¤è¿è¡Œï¼ˆå†—ä½™è§¦å‘æˆ–æ‰‹åŠ¨è§¦å‘é‡å ï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„å¯†é’¥é…ç½®
  RQ_COOKIE: ${{ secrets.RQ_COOKIE }}
  RQ_CSRF_TOKEN: ${{ secrets.RQ_CSRF_TOKEN }}
  RQ_USERID: ${{ secrets.RQ_USERID }}
  GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
  GOOGLE_API_CLIENT_EMAIL: ${{ secrets.GOOGLE_API_CLIENT_EMAIL }}
  GOOGLE_API_PRIVATE_KEY: ${{ secrets.GOOGLE_API_PRIVATE_KEY }}
  BARK_KEY: ${{ secrets.BARK_KEY }}
  GARMIN_USERNAME: ${{ secrets.GARMIN_USERNAME }}
  GARMIN_PASSWORD: ${{ secrets.GARMIN_PASSWORD }}
  GARMIN_GLOBAL_USERNAME: ${{ secrets.GARMIN_GLOBAL_USERNAME }}
  GARMIN_GLOBAL_PASSWORD: ${{ secrets.GARMIN_GLOBAL_PASSWORD }}

jobs:
  build:
    runs-on: ubuntu-latest
    name: Sync Garmin CN to Garmin Global
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'

      - name: ğŸ•’ Print trigger & time info
        run: |
          echo "Trigger type: $GITHUB_EVENT_NAME"
          echo "Cron schedule: ${{ github.event.schedule || 'Manual / Push' }}"
          echo "UTC now:   $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
          echo "Beijing:   $(date '+%Y-%m-%d %H:%M:%S %Z')"

          # è®¡ç®—ç†è®ºè§¦å‘ç‚¹ï¼ˆæ¯ä¸¤å°æ—¶çš„ç¬¬18åˆ†é’Ÿï¼‰
          now=$(date -u +%s)
          expected=$(( (now/7200)*7200 + 1080 ))  # 1080 ç§’ = 18 åˆ†é’Ÿ
          if [ "$expected" -gt "$now" ]; then expected=$(( expected - 7200 )); fi
          drift=$(( now - expected ))
          echo "Expected UTC trigger: $(date -u -d @${expected} '+%Y-%m-%d %H:%M:%S %Z')"
          echo "Actual UTC start:     $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
          echo "â±ï¸ Drift: ${drift}s ($((drift/60)) min delay)"
          if [ "$drift" -gt 1200 ]; then
            echo "::warning::Trigger delayed >20min (${drift}s)"
          fi

      - run: yarn
      - run: yarn sync_cn
        timeout-minutes: 5

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Save Garmin Session
