name: Sync Garmin CN to Garmin Global

on:
  workflow_dispatch:
  schedule:
    # ä¸»é”šç‚¹ï¼ˆUTCï¼‰ï¼š23:18ã€00:18ã€01:18ã€02:18ã€03:18ã€09:18ã€13:18
    # â†” åŒ—äº¬æ—¶é—´ï¼š07:18ã€08:18ã€09:18ã€10:18ã€11:18ã€17:18ã€21:18
    - cron: "18 23,0,1,2,3,9,13 * * *"
    # å†—ä½™é”šç‚¹ï¼ˆUTCï¼‰ï¼š23:43ã€00:43ã€01:43ã€02:43ã€03:43ã€09:43ã€13:43
    # â†” åŒ—äº¬æ—¶é—´ï¼š07:43ã€08:43ã€09:43ã€10:43ã€11:43ã€17:43ã€21:43
    - cron: "43 23,0,1,2,3,9,13 * * *"
  push:
    branches:
      - main

# é¿å…å†—ä½™è§¦å‘/æ‰‹åŠ¨è§¦å‘å¯¼è‡´çš„å¹¶å‘
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„å¯†é’¥é…ç½®ï¼ˆå»ºè®®å…¨éƒ¨ç”¨ Secretsï¼‰
  RQ_COOKIE: ${{ secrets.RQ_COOKIE }}
  RQ_CSRF_TOKEN: ${{ secrets.RQ_CSRF_TOKEN }}
  RQ_USERID: ${{ secrets.RQ_USERID }}
  GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
  GOOGLE_API_CLIENT_EMAIL: ${{ secrets.GOOGLE_API_CLIENT_EMAIL }}
  GOOGLE_API_PRIVATE_KEY: ${{ secrets.GOOGLE_API_PRIVATE_KEY }}
  BARK_KEY: ${{ secrets.BARK_KEY }}
  GARMIN_USERNAME: ${{ secrets.GARMIN_USERNAME }}
  GARMIN_PASSWORD: ${{ secrets.GARMIN_PASSWORD }}
  GARMIN_GLOBAL_USERNAME: ${{ secrets.GARMIN_GLOBAL_USERNAME }}
  GARMIN_GLOBAL_PASSWORD: ${{ secrets.GARMIN_GLOBAL_PASSWORD }}

jobs:
  build:
    runs-on: ubuntu-latest
    name: Sync Garmin CN to Garmin Global
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'

      - name: ğŸ•’ Print trigger & time info (with drift calc)
        shell: bash
        run: |
          echo "Trigger type: $GITHUB_EVENT_NAME"
          echo "Cron schedule: ${{ github.event.schedule || 'Manual / Push' }}"
          echo "UTC now:   $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
          echo "Beijing:   $(date    '+%Y-%m-%d %H:%M:%S %Z')"

          # ä»…åœ¨ schedule è§¦å‘æ—¶è®¡ç®—â€œç†è®ºè§¦å‘ç‚¹â€
          if [ "$GITHUB_EVENT_NAME" = "schedule" ]; then
            CRON="${{ github.event.schedule }}"
            # è§£æåˆ†é’Ÿä¸å°æ—¶å­—æ®µï¼ˆåªæ”¯æŒä½ å½“å‰è¿™ç§ï¼šå›ºå®šåˆ†é’Ÿ + é€—å·åˆ†éš”çš„å°æ—¶åˆ—è¡¨ï¼‰
            MINUTE=$(awk '{print $1}' <<< "$CRON")
            HOURS=$(awk '{print $2}' <<< "$CRON")

            if [[ "$MINUTE" =~ ^[0-9]+$ ]] && [[ "$HOURS" =~ ^[0-9,]+$ ]]; then
              now_ts=$(date -u +%s)
              today=$(date -u +%Y-%m-%d)
              expected_ts=0

              # éå†å°æ—¶åˆ—è¡¨ï¼Œç”Ÿæˆå€™é€‰æ—¶é—´ï¼ˆä¼˜å…ˆå–ä»Šå¤©ï¼›è‹¥æ™šäºç°åœ¨åˆ™å›é€€åˆ°æ˜¨å¤©ï¼‰
              for h in $(echo "$HOURS" | tr ',' ' '); do
                ts=$(date -u -d "$today $(printf '%02d' $h):$(printf '%02d' $MINUTE):00" +%s)
                if [ $ts -gt $now_ts ]; then
                  ts=$(( ts - 86400 ))  # å›é€€ä¸€å¤©
                fi
                # å–ä¸æ™šäº now çš„æœ€å¤§ä¸€ä¸ª
                if [ $ts -le $now_ts ] && { [ $expected_ts -eq 0 ] || [ $ts -gt $expected_ts ]; }; then
                  expected_ts=$ts
                fi
              done

              if [ $expected_ts -gt 0 ]; then
                drift=$(( now_ts - expected_ts ))
                echo "Expected UTC trigger: $(date -u -d @${expected_ts} '+%Y-%m-%d %H:%M:%S %Z')"
                echo "Actual UTC start:     $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
                echo "â±ï¸ Drift: ${drift}s ($((drift/60)) min delay)"
                # è¶…è¿‡ 20 åˆ†é’Ÿç»™æç¤ºï¼ˆå¯è‡ªå·±è°ƒé˜ˆå€¼æˆ–åˆ é™¤ï¼‰
                if [ "$drift" -gt 1200 ]; then
                  echo "::warning::Trigger delayed >20min (${drift}s)"
                fi
              else
                echo "Could not compute expected trigger time (no candidate <= now)."
              fi
            else
              echo "Cron pattern not supported by this drift calculator: $CRON"
            fi
          else
            echo "Non-schedule trigger; skip drift calculation."
          fi

      - run: yarn
      - run: yarn sync_cn
        timeout-minutes: 5

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Save Garmin Session
